# BOLT＃1：基本协议

## 概观

该协议假定一种基础认证和有序传输机制，负责构建单个消息。
[BOLT＃8]（08-transport.md）指定Lightning中使用的规范传输层，但它可以由满足上述保证的任何传输替换。

默认TCP端口是9735.这对应于十六进制“0x2607”：LIGHTNING的Unicode代码点。 <sup> [1]（＃reference-1）</sup>

除非另有说明，否则所有数据字段均为无符号大端。

## 目录

  * [连接处理和多路复用](#connection-handling-and-multiplexing)
  * [闪电消息格式](#lightning-message-format)
  * [设置消息](#setup-messages)
    * [`init`消息](#the-init-message)
    * [`error`消息](#the-error-message)
  * [控制消息](#control-messages)
    * [`ping`和`pong`消息](#the-ping-and-pong-messages)
  * [致谢](#acknowledgments)
  * [参考](#references)
  * [作者](#authors)

## 连接处理和多路复用

实现必须使用每个对等体的单个连接;通道消息（包括通道ID）通过此单个连接进行多路复用。

## 闪电消息格式

解密后，所有Lightning消息都具有以下形式：

1. `type`：一个2字节的big-endian字段，表示消息的类型
2. `payload`：一个可变长度的有效载荷，包含其余部分
   消息和符合与`type`匹配的格式

`type`字段表示如何解释`payload`字段。
每种类型的格式由此存储库中的规范定义。
该类型遵循_it的确定为odd_规则，因此节点可以发送_odd_编号类型而不确定接收者是否理解它。

发送节点：
  - 未经事先协商，不得发送此处未列出的均匀类型的消息。

接收节点：
  - 收到_odd_，未知类型的消息后：
    - 必须忽略收到的消息。
  - 收到_even_消息后，未知类型：
    - 必须通道失败。

消息按逻辑分组为四组，按设置的最高有效位排序：

  - 设置和控制（类型`0`-`31`）：与连接设置，控制，支持的功能和错误报告相关的消息（如下所述）
  - 频道（类型`32`-`127`）：用于设置和拆除微支付频道的消息（在[BOLT＃2]（02-peer-protocol.md）中描述）
  - 承诺（类型`128`-`255'）：与更新当前承诺交易相关的消息，包括添加，撤销和结算HTLC以及更新费用和交换签名（在[BOLT＃2]中描述（02-peer） -protocol.md））
  - 路由（类型`256`-`511'）：包含节点和通道公告的消息，以及任何活动路径探索（在[BOLT＃7]中描述（07-routing-gossip.md））

传输层需要消息的大小以适合2字节的unsigned int;因此，最大可能大小为65535字节。

一个节点：
  - 必须忽略消息中超出其对该类型所期望的长度的任何其他数据。
  - 在收到内容长度不足的已知消息时：
    - 必须通道失败。
  - 在本规范中协商一个选项：
    - 必须包括用该选项注释的所有字段。

### 合理

默认情况下，`SHA2`和比特币公钥都被编码为
big endian，因此使用不同的endian是不常见的
其他领域。

密码包装将长度限制为65535字节，并且
无论如何，协议中的消息永远不会超过该长度。

_it可以是odd_规则允许将来可选的扩展
无需在客户中进行协商或特殊编码“忽略
附加数据“规则同样允许未来扩展。

实现可能更喜欢在8字节上对齐消息数据
边界（这里任何类型的最大自然对齐要求）;
但是，在考虑类型字段后添加6字节填充
浪费：可以通过解密消息来实现对齐
具有6字节预填充的缓冲区。

## 设置消息

### `init`消息

身份验证完成后，第一条消息将显示此节点支持或要求的功能，即使这是重新连接。

[BOLT＃9]（09-features.md）指定全局和本地功能的列表。每个特征通常用“globalfeatures”或“localfeatures”表示2位。最低有效位编号为0，即_even_，下一个最高有效位编号为1，即_odd_。

两个字段`globalfeatures`和`localfeatures`必须用0填充到字节。

1. 类型：16（`init`）
2. 数据：
   * [`2`：`gflen`]
   * [`gflen`：`globalfeatures`]
   * [`2`：`lflen`]
   * [`lflen`：`localfeatures`]

2字节的`gflen`和`lflen`字段表示紧随其后的字段中的字节数。

#### 要求

发送节点：
  - 必须发送`init`作为任何连接的第一个Lightning消息。
  - 必须按[BOLT＃9]（09-features.md）中的定义设置功能位。
  - 必须将任何未定义的功能位设置为0。
  - 应该使用表示要素字段所需的最小长度。

接收节点：
  - 在发送任何其他消息之前必须等待接收`init`。
  - 必须响应[BOLT＃9]（09-features.md）中指定的已知特征位。
  - 在接收到非零的未知_odd_特征位时：
    - 必须忽略这个位。
  - 在接收到非零的未知_even_特征位时：
    - 必须使连接失败。

#### 合理

此语义允许将来不兼容的更改和将来向后兼容的更改。通常应成对分配比特，以便以后可选功能成为强制性的。

节点等待接收其他功能以简化错误
功能不兼容时的诊断。

功能掩码分为局部特征（仅影响
这两个节点之间的协议）和全局特征（可以影响
HTLC因此也被广告到其他节点）。

### `error`消息

为了简化诊断，告诉对等体某些内容不正确通常很有用。

1. 类型：17（`错误`）
2. 数据：
   * [`32`：`channel_id`]
   * [`2`：`len`]
   * [`len`：`data`]

2字节的“len”字段表示紧随其后的字段中的字节数。

#### 要求

信道由`channel_id`引用，除非`channel_id`为0（即所有字节都是0），在这种情况下它指的是所有信道。

资金节点：
  - 对于在（funding_created）消息之前（包括）发送的所有错误消息：
    - 必须使用`temporary_channel_id`来代替`channel_id`。

有趣的节点：
  - 对于在（funding_signed）消息之前发送的（并且不包括）所有错误消息：
    - 必须使用`temporary_channel_id`来代替`channel_id`。

发送节点：
  - 发送'错误'时：
    - 必须使错误消息引用的通道失败。
  - 应该发送协议违规或内部错误的“错误”，使通道无法使用或使进一步的通信无法使用。
  - 应该发送带有未知`channel_id`的`error`来回复与未知频道相关的类型为'32`-`255'的消息。
  - 可以发送一个空的`data`字段。
  - 当失败是由无效的签名检查引起的：
    - 应该包括原始的十六进制编码事务，以回复`funding_created`，`funding_signed`，`closing_signed`或`commitment_signed`消息。
  - 当`channel_id`为0时：
    - 必须使接收节点的所有通道都失败。
    - 必须关闭连接。
  - 必须将`len`设置为等于`data`的长度。

接收节点：
  - 收到“错误”后：
    - 如果该通道与发送节点在一起，则必须使错误消息引用的通道失败。
  - 如果消息没有引用现有频道：
    - 必须忽略该消息。
  - 必须将`len`截断到数据包的其余部分（如果它更大）。
  - 如果`data`不仅仅由可打印的ASCII字符组成（供参考：可打印字符集包括字节值32到126，包括端点）：
    - 不应该逐字打印出`data`。

#### 合理

存在不可恢复的错误，需要中止对话;
如果简单地断开连接，那么对等体可以重试
连接。描述协议违规也很有用
诊断，因为这表明一个同伴有一个错误。

明智的做法是不要区分生产设置中的错误，以免
它泄漏信息 - 因此，可选的`data`字段。

## 控制消息

### `ping`和`pong`消息

为了允许存在长期的TCP连接，at
时间可能需要两端保持活动的TCP连接
应用水平。此类消息还允许混淆交通模式。

1. 类型：18（`ping`）
2. 数据：
    * [`2`：`num_pong_bytes`]
    * [`2`：`byteslen`]
    * [`byteslen`：`ignored`]

只要收到`ping`消息，就会发送`pong`消息。它
作为回复，也用于保持连接活着
明确告知另一端接收器仍处于活动状态。内
收到`ping`消息后，发送方将指定要的字节数
包含在`pong`消息的数据有效载荷中。

1. 类型：19（`pong`）
2. 数据：
    * [`2`：`byteslen`]
    * [`byteslen`：`ignored`]

#### 要求

发送“ping”消息的节点：
  - 应该将`ignored`设置为0。
  - 绝不能将`ignored`设置为敏感数据，如秘密或初始化部分
记忆。
  - 如果它没有收到相应的“乒乓球”：
    - 可以终止网络连接，
      - 在这种情况下，不得使通道失效。
  - 不应该每隔30秒发送一次“ping”消息，而不是一次。

发送“pong”消息的节点：
  - 应该将`ignored`设置为0。
  - 绝不能将`ignored`设置为敏感数据，如秘密或初始化部分
 记忆。

接收“ping”消息的节点：
  - 如果频道每30秒收到一次“ping”，那么它应该会失败。
  - 如果`num_pong_bytes`小于65532：
    - 必须通过发送`pong`消息来响应，`byteslen`等于`num_pong_bytes`。
  - 否则（`num_pong_bytes` ** **不小于65532）：
    - 必须忽略`ping`。

接收“pong”消息的节点：
  - 如果`byteslen`与它发送的任何`ping`的`num_pong_bytes`值不对应：
    - 可能会失败频道。

### 合理

最大可能的消息是65535字节;因此，最大的敏感`byteslen`
是65531  - 为了说明类型字段（`pong`）和`byteslen`本身。这允许
`num_pong_bytes`的方便截止，表示不应发送回复。

网络中节点之间的连接可能是长期的，作为支付
渠道有无限期的生命。但是，很有可能
没有新的数据
交换了一个
连接生命周期的重要部分。此外，在几个平台上，Lightning可能也是如此
客户将在没有事先警告的情况下入睡。因此，a
使用不同的`ping`消息，以便探测连接的活跃性
另一方面，以及保持已建立的连接活跃。

此外，发送方能够请求接收方发送一个
具有特定字节数的响应使网络上的节点能够
创建_synthetic_流量。这种流量可以用来部分防御
反对数据包和时序分析 - 因为节点可以伪造流量模式
典型的交流，没有对他们各自的任何真正的更新
通道。

与中定义的洋葱路由协议结合使用时
[BOLT＃4]（04-onion-routing.md），
谨慎的统计驱动的综合交通可以进一步加强
网络中参与者的隐私。

对于“ping”泛滥，建议采取有限的预防措施
由于网络延迟，给出了纬度。请注意，还有其他方法
传入流量泛滥（例如发送_odd_未知消息类型或填充
最大的每条消息）。

最后，定期`ping`消息的使用有助于促进频繁的密钥
[BOLT＃8]（08-transport.md）中指定的旋转。

## 致谢

[TODO :( roasbeef）;鳍]

## 参考

1.  <a id="reference-2"> http://www.unicode.org/charts/PDF/U2600.pdf </a>

## 作者

[FIXME：插入作者列表]

！[知识共享许可]（https://i.creativecommons.org/l/by/4.0/88x31.png“许可证CC-BY”）
 <br>
本作品采用[知识共享署名4.0国际许可]（http://creativecommons.org/licenses/by/4.0/）许可。
